<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Add Anime or Movie</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body { font-family: Arial; margin: 20px; }
    input, select, button {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      font-size: 16px;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
    }
  </style>
</head>

<body>

<h1>Add Anime or Movie</h1>
<a href="index.html">â¬… Back</a>

<select id="type">
  <option value="anime">Anime</option>
  <option value="movie">Movie</option>
</select>

<input type="text" id="searchInput" placeholder="Type and press Search">

<button onclick="search()">Search</button>

<select id="results" size="6"></select>

<button onclick="addSelected()">Add Selected</button>

<script>
const TMDB_KEY = "2c99c7f6a5ee358bbb0dce7c47b8e374";

async function search() {
  const query = document.getElementById("searchInput").value.trim();
  const type = document.getElementById("type").value;
  const resultsDropdown = document.getElementById("results");

  resultsDropdown.innerHTML = "";

  if (!query) return;

  if (type === "anime") {

    const res = await fetch("https://graphql.anilist.co", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        query: `
          query ($search: String) {
            Page(perPage: 5) {
              media(search: $search, type: ANIME) {
                id
                title { romaji english }
                startDate { year }
              }
            }
          }
        `,
        variables: { search: query }
      })
    });

    const data = await res.json();
    const results = data.data.Page.media;

    results.forEach(anime => {
      const option = document.createElement("option");
      option.value = anime.id;
      option.textContent =
        (anime.title.english || anime.title.romaji) +
        " (" + (anime.startDate.year || "?") + ")";
      option.dataset.title =
        anime.title.english || anime.title.romaji;
      resultsDropdown.appendChild(option);
    });

  } else {

    const res = await fetch(
      `https://api.themoviedb.org/3/search/movie?api_key=${TMDB_KEY}&query=${encodeURIComponent(query)}`
    );

    const data = await res.json();
    const results = data.results.slice(0,5);

    results.forEach(movie => {
      const option = document.createElement("option");
      option.value = movie.id;
      option.textContent =
        movie.title + " (" +
        (movie.release_date ? movie.release_date.split("-")[0] : "?") + ")";
      option.dataset.title = movie.title;
      resultsDropdown.appendChild(option);
    });
  }
}

function addSelected() {
  const dropdown = document.getElementById("results");
  const selected = dropdown.options[dropdown.selectedIndex];

  if (!selected) {
    alert("Select something first.");
    return;
  }

  const type = document.getElementById("type").value;
  const title = selected.dataset.title;

  const items = JSON.parse(localStorage.getItem("myPicks") || "[]");
  items.push({ type, title });
  localStorage.setItem("myPicks", JSON.stringify(items));

  window.location.href = "index.html";
}
</script>

</body>
</html>
